<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR 실시간 계산기</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; color: #1c1e21; }
        .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 400px; margin: auto; }
        h2 { margin-top: 0; font-size: 1.5rem; text-align: center; }
        .input-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: #606770; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .status { font-size: 0.8rem; text-align: right; margin-bottom: 10px; color: #3498db; }
        button { width: 100%; padding: 14px; background: #1877f2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        #result { margin-top: 20px; padding: 16px; border-radius: 8px; display: none; line-height: 1.6; }
        .buy { background: #ffebee; border-left: 5px solid #ff5252; }
        .sell { background: #e8f5e9; border-left: 5px solid #4caf50; }
        .symbol-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h2>VR 실시간 리밸런싱</h2>
        
        <div class="input-group">
            <label>API Key (Finnhub)</label>
            <input type="text" id="apiKey" placeholder="API 키를 입력하세요">
        </div>

        <div class="input-group">
            <label>티커 (예: TQQQ)</label>
            <input type="text" id="symbol" value="TQQQ" style="text-transform:uppercase">
        </div>

        <div id="priceStatus" class="status">실시간 주가 대기 중...</div>

        <div class="input-group">
            <label>현재 보유 수량 (개)</label>
            <input type="number" id="holdings" placeholder="예: 150">
        </div>

        <div class="input-group">
            <label>목표 밸류 (V, $)</label>
            <input type="number" id="targetValue" placeholder="예: 15000">
        </div>

        <button onclick="startTracking()">1분마다 자동 계산 시작</button>

        <div id="result"></div>
    </div>

    <script>
        let timer = null;
        let currentPrice = 0;

        async function fetchPrice() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            const apiKey = document.getElementById('apiKey').value;
            
            if(!apiKey) {
                alert("API Key가 필요합니다.");
                return;
            }

            try {
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
                const data = await response.json();
                
                if(data.c) {
                    currentPrice = data.c;
                    document.getElementById('priceStatus').innerText = `현재 ${symbol} 주가: $${currentPrice} (갱신됨)`;
                    calculateVR();
                } else {
                    document.getElementById('priceStatus').innerText = "주가를 가져오지 못했습니다. (티커 확인)";
                }
            } catch (error) {
                console.error("API 호출 오류:", error);
            }
        }

        function calculateVR() {
            const stocks = parseFloat(document.getElementById('holdings').value);
            const target = parseFloat(document.getElementById('targetValue').value);
            const resultDiv = document.getElementById('result');

            if(!currentPrice || !stocks || !target) return;

            const currentEval = currentPrice * stocks;
            const diff = target - currentEval; // (V - 현재평가금)
            
            resultDiv.style.display = "block";
            
            if (diff > 0) {
                resultDiv.className = "buy";
                resultDiv.innerHTML = `<strong>[매수 가이드]</strong><br>현재 평가금: $${currentEval.toFixed(2)}<br>부족분: $${diff.toFixed(2)}만큼 LOC 매수 필요`;
            } else {
                resultDiv.className = "sell";
                resultDiv.innerHTML = `<strong>[매도 가이드]</strong><br>현재 평가금: $${currentEval.toFixed(2)}<br>초과분: $${Math.abs(diff).toFixed(2)}만큼 LOC 매도 필요`;
            }
        }

        function startTracking() {
            if(timer) clearInterval(timer);
            
            // 즉시 한 번 실행
            fetchPrice();
            
            // 1분(60000ms)마다 반복 실행
            timer = setInterval(fetchPrice, 60000);
            alert("자동 갱신이 시작되었습니다. (1분 간격)");
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
