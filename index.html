<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VR ë¦¬ë°¸ëŸ°ì‹± ë§¤ë‹ˆì €</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com">
        if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
  </script>
  <style>
    body { margin: 0; padding: 0; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen">
  <div id="app" class="max-w-6xl mx-auto p-4"></div>

  <script>
    // [ë°ì´í„° ëª¨ë¸] ì´ˆê¸°ê°’ì— Gê°’ ì¶”ê°€
    function loadData() {
      const saved = localStorage.getItem('vr-portfolios');
      if (saved) return JSON.parse(saved);
      return [{
        id: Date.now(),
        ticker: 'TQQQ',
        totalCapital: 10000,
        currentPrice: 65.5,
        gValue: 100, // ì¶”ê°€ëœ Gê°’ (íšŒì°¨ë³„ ëª©í‘œ ê°€ì¹˜ ì¦ê°€ë¶„)
        targetReturn: 10,
        purchases: []
      }];
    }

    function saveData(data) {
      localStorage.setItem('vr-portfolios', JSON.stringify(data));
    }

    let portfolios = loadData();
    let selectedIndex = 0;
    let priceLoading = false;

    // [ê³„ì‚° í•¨ìˆ˜] Gê°’ ê¸°ë°˜ ë°¸ë¥˜ ë¦¬ë°¸ëŸ°ì‹± ë¡œì§
    function getStats(portfolio) {
      const totalShares = portfolio.purchases.reduce((sum, p) => sum + p.shares, 0);
      const totalCost = portfolio.purchases.reduce((sum, p) => sum + (p.price * p.shares), 0);
      const avgPrice = totalShares > 0 ? totalCost / totalShares : 0;
      const currentValue = totalShares * portfolio.currentPrice;
      const returnRate = totalCost > 0 ? ((currentValue - totalCost) / totalCost) * 100 : 0;
      
      // ì ë¦½ì‹ VR í•µì‹¬: ëª©í‘œ ë°¸ë¥˜ = (Gê°’ * ë§¤ìˆ˜íšŒì°¨)
      const currentTurn = portfolio.purchases.length;
      const targetValue = portfolio.gValue * currentTurn;
      
      return { totalShares, totalCost, avgPrice, currentValue, returnRate, targetValue, currentTurn };
    }

    // [UI ë Œë”ë§]
    function render() {
      const p = portfolios[selectedIndex];
      const stats = getStats(p);

      document.getElementById('app').innerHTML = `
        <header class="mb-8 pt-4 flex justify-between items-center flex-wrap gap-4">
          <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">VR ë§¤ë‹ˆì €</h1>
            <p class="text-slate-400 text-sm">ë¼ì˜¤ì–´ ë°¸ë¥˜ ë¦¬ë°¸ëŸ°ì‹± ë„êµ¬</p>
          </div>
          <div class="flex gap-2">
            <button onclick="exportData()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-xs">ğŸ’¾ ë°±ì—…</button>
            <button onclick="importData()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-xs">ğŸ“‚ ë³µì›</button>
            <button onclick="addPortfolio()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-sm font-bold">â• ì¢…ëª© ì¶”ê°€</button>
          </div>
        </header>

        <div class="flex gap-2 mb-6 overflow-x-auto">
          ${portfolios.map((item, i) => `
            <button onclick="selectedIndex=${i};render()" class="px-4 py-2 rounded-t-lg transition-colors ${i === selectedIndex ? 'bg-slate-800 text-blue-400 border-b-2 border-blue-400' : 'bg-slate-900/50 text-slate-500'}">
              ${item.ticker}
            </button>
          `).join('')}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h2 class="text-2xl font-bold">${p.ticker} ëŒ€ì‹œë³´ë“œ</h2>
                  <p class="text-slate-400 text-sm">í˜„ì¬ ${stats.currentTurn}íšŒì°¨ ìš´ìš© ì¤‘</p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-slate-500 mb-1">í˜„ì¬ê°€ ì—…ë°ì´íŠ¸</p>
                  <div class="flex gap-2">
                    <input type="number" step="0.01" value="${p.currentPrice}" onchange="updatePrice(this.value)" class="w-24 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-sm">
                    <button onclick="fetchPrice('${p.ticker}')" class="bg-green-600 px-3 py-1 rounded text-xs font-bold ${priceLoading ? 'animate-pulse' : ''}">ì‹¤ì‹œê°„ì¡°íšŒ</button>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-900 p-4 rounded-lg">
                  <p class="text-slate-500 text-xs mb-1">Gê°’ (íšŒì°¨ë³„ ì¦ê°€ë¶„)</p>
                  <input type="number" value="${p.gValue}" onchange="updateGValue(this.value)" class="w-full bg-transparent text-xl font-bold text-amber-400 focus:outline-none">
                </div>
                <div class="bg-slate-900 p-4 rounded-lg">
                  <p class="text-slate-500 text-xs mb-1">ëª©í‘œ ë°¸ë¥˜(TV)</p>
                  <p class="text-xl font-bold text-cyan-400">$${stats.targetValue.toLocaleString()}</p>
                </div>
                <div class="bg-slate-900 p-4 rounded-lg">
                  <p class="text-slate-500 text-xs mb-1">í˜„ì¬ ë°¸ë¥˜(CV)</p>
                  <p class="text-xl font-bold text-blue-400">$${stats.currentValue.toLocaleString(undefined, {maximumFractionDigits:0})}</p>
                </div>
                <div class="bg-slate-900 p-4 rounded-lg">
                  <p class="text-slate-500 text-xs mb-1">ìˆ˜ìµë¥ </p>
                  <p class="text-xl font-bold ${stats.returnRate >= 0 ? 'text-green-400' : 'text-red-400'}">${stats.returnRate.toFixed(2)}%</p>
                </div>
              </div>
            </div>

            <div class="bg-blue-900/20 p-6 rounded-xl border border-blue-800/50">
              <h3 class="text-lg font-bold mb-4 text-blue-300">ğŸ’¡ ë‹¤ìŒ íšŒì°¨ í–‰ë™ ê°€ì´ë“œ</h3>
              ${stats.currentValue > stats.targetValue 
                ? `<p class="text-amber-300 font-semibold">í˜„ì¬ ë°¸ë¥˜ê°€ ëª©í‘œë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤. ì›ì¹™ì— ë”°ë¼ <span class="text-xl text-amber-500 underline">ë§¤ë„(ë¦¬ë°¸ëŸ°ì‹±)</span>ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.</p>`
                : `<p class="text-cyan-300 font-semibold">í˜„ì¬ ë°¸ë¥˜ê°€ ëª©í‘œë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤. <span class="text-xl text-cyan-500 underline">ë§¤ìˆ˜</span>ë¥¼ í†µí•´ ëª©í‘œ ë°¸ë¥˜ë¥¼ ì±„ìš°ì„¸ìš”.</p>`
              }
            </div>
          </div>

          <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-bold mb-4">ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡</h3>
            <div class="space-y-3">
              <input type="number" id="buyPrice" placeholder="ë‹¨ê°€" value="${p.currentPrice}" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2">
              <input type="number" id="buyShares" placeholder="ìˆ˜ëŸ‰ (ë§¤ë„ëŠ” ë§ˆì´ë„ˆìŠ¤)" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2">
              <button onclick="addRecord()" class="w-full bg-blue-600 py-3 rounded-lg font-bold hover:bg-blue-500 transition-colors">ê¸°ë¡ ì €ì¥</button>
            </div>
            
            <div class="mt-6 border-t border-slate-700 pt-4">
              <h4 class="text-sm font-bold text-slate-400 mb-3">ìµœê·¼ ê¸°ë¡</h4>
              <div class="space-y-2 max-h-60 overflow-y-auto pr-2 text-xs">
                ${p.purchases.slice().reverse().map((r, i) => `
                  <div class="flex justify-between bg-slate-900 p-2 rounded">
                    <span>${new Date(r.date).toLocaleDateString()}</span>
                    <span class="${r.shares >= 0 ? 'text-cyan-400' : 'text-red-400'}">${r.shares}ì£¼</span>
                    <span class="text-slate-300">$${r.price}</span>
                    <button onclick="deleteRecord(${p.purchases.length - 1 - i})" class="text-slate-600">âœ•</button>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // [ì œì–´ ë¡œì§]
    async function fetchPrice(ticker) {
      priceLoading = true; render();
      try {
        const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1m&range=1d`);
        const data = await res.json();
        const price = data.chart.result[0].meta.regularMarketPrice;
        portfolios[selectedIndex].currentPrice = price;
        saveData(portfolios);
      } catch (e) { alert('ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨'); }
      priceLoading = false; render();
    }

    function updateGValue(val) {
      portfolios[selectedIndex].gValue = parseFloat(val);
      saveData(portfolios);
      render();
    }

    function updatePrice(val) {
      portfolios[selectedIndex].currentPrice = parseFloat(val);
      saveData(portfolios);
      render();
    }

    function addRecord() {
      const price = parseFloat(document.getElementById('buyPrice').value);
      const shares = parseFloat(document.getElementById('buyShares').value);
      if(!price || !shares) return;
      
      portfolios[selectedIndex].purchases.push({
        date: new Date().toISOString(),
        price,
        shares
      });
      saveData(portfolios);
      render();
    }

    function deleteRecord(idx) {
      if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        portfolios[selectedIndex].purchases.splice(idx, 1);
        saveData(portfolios);
        render();
      }
    }

    function addPortfolio() {
      const ticker = prompt('í‹°ì»¤ ì…ë ¥(ì˜ˆ: SOXL):');
      if(!ticker) return;
      portfolios.push({
        id: Date.now(),
        ticker: ticker.toUpperCase(),
        gValue: 100,
        currentPrice: 0,
        purchases: []
      });
      selectedIndex = portfolios.length - 1;
      saveData(portfolios);
      render();
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(portfolios)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'vr-backup.json'; a.click();
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          portfolios = JSON.parse(ev.target.result);
          saveData(portfolios); render();
        };
        reader.readAsText(e.target.files[0]);
      };
      input.click();
    }

    render();
  </script>
</body>
</html>
